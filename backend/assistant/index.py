import json
import os
import urllib.request
from typing import Dict, Any

def handler(event: Dict[str, Any], context: Any) -> Dict[str, Any]:
    '''AI assistant –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç–ü—Ä–æ'''
    method: str = event.get('httpMethod', 'GET')
    
    if method == 'OPTIONS':
        return {
            'statusCode': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type, X-User-Id',
                'Access-Control-Max-Age': '86400'
            },
            'body': ''
        }
    
    if method == 'POST':
        body_str = event.get('body', '')
        if not body_str or body_str.strip() == '':
            body_str = '{}'
        body_data = json.loads(body_str)
        user_message = body_data.get('message', '')
        context = body_data.get('context', '')
        
        if not user_message:
            return {
                'statusCode': 400,
                'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                'body': json.dumps({'error': 'Message is required'})
            }
        
        openrouter_key = os.environ.get('OPENROUTER_API_KEY', '')
        
        if not openrouter_key:
            return {
                'statusCode': 500,
                'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                'body': json.dumps({'response': '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É @Fou9725'})
            }
        
        system_prompt = """–¢—ã ‚Äî –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç–ü—Ä–æ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.

**–û –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç–ü—Ä–æ:**
–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç–ü—Ä–æ ‚Äî —ç—Ç–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —É–º–Ω—ã—Ö –ò–ò-—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ –ò–ò-–∞–≥–µ–Ω—Ç–æ–≤ –±–µ–∑ –∑–Ω–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è.

**–¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã:**
1. **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π** (0‚ÇΩ): 
   - 1 –ò–ò-–∞–≥–µ–Ω—Ç
   - –î–æ 100 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–µ—Å—è—Ü
   - –ë–∞–∑–æ–≤—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
   - –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä: –±–∞–∑–æ–≤—ã–µ –±–ª–æ–∫–∏
   - 3 —à–∞–±–ª–æ–Ω–∞ N8N
   - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞

2. **–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π** (990‚ÇΩ/–º–µ—Å):
   - –î–æ 5 –ò–ò-–∞–≥–µ–Ω—Ç–æ–≤
   - –î–æ 10,000 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–µ—Å—è—Ü
   - –í—Å–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
   - –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä Pro: –≤—Å–µ –±–ª–æ–∫–∏
   - 20 —à–∞–±–ª–æ–Ω–æ–≤ N8N
   - –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ –ø–æ —Ç–µ–∫—Å—Ç—É (5/–º–µ—Å—è—Ü)
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
   - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

3. **–ü—Ä–µ–º–∏—É–º** (2,990‚ÇΩ/–º–µ—Å):
   - –ë–µ–∑–ª–∏–º–∏—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ò–ò-–∞–≥–µ–Ω—Ç–æ–≤
   - –î–æ 100,000 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–µ—Å—è—Ü
   - –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ
   - –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä Premium: –≤—Å–µ –±–ª–æ–∫–∏ + AI
   - –í—Å–µ —à–∞–±–ª–æ–Ω—ã N8N (–±–µ–∑–ª–∏–º–∏—Ç)
   - –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ –ø–æ —Ç–µ–∫—Å—Ç—É (–±–µ–∑–ª–∏–º–∏—Ç)
   - –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
   - API –¥–æ—Å—Ç—É–ø
   - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä

4. **–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π** (9,990‚ÇΩ/–º–µ—Å):
   - –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ü—Ä–µ–º–∏—É–º
   - –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä Partner: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç + –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å–≤–æ–∏—Ö —à–∞–±–ª–æ–Ω–æ–≤
   - –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –∫–∞–±–∏–Ω–µ—Ç —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π
   - –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å –∫–æ–º–∏—Å—Å–∏–µ–π 20%
   - –ü–æ–∂–∏–∑–Ω–µ–Ω–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è –æ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
   - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞
   - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è

**–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞:**
- –ö–æ–º–∏—Å—Å–∏—è 20% –æ—Ç –∫–∞–∂–¥–æ–π –æ–ø–ª–∞—Ç—ã –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ü–æ–∂–∏–∑–Ω–µ–Ω–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è (–ø–æ–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª –ø–ª–∞—Ç–∏—Ç)
- –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –∫–∞–±–∏–Ω–µ—Ç —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –∏ –¥–æ—Ö–æ–¥–æ–≤
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã:**
- –°–æ–∑–¥–∞–Ω–∏–µ –ò–ò-—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ –ò–ò-–∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è Telegram, WhatsApp, VK
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI, Claude, YandexGPT
- –í–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å N8N —à–∞–±–ª–æ–Ω–∞–º–∏ (–¥–æ—Å—Ç—É–ø–µ–Ω –≤–æ –≤—Å–µ—Ö —Ç–∞—Ä–∏—Ñ–∞—Ö)
- –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–æ–≤ –ø–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É —Å –ø–æ–º–æ—â—å—é AI (—Å —Ç–∞—Ä–∏—Ñ–∞ –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π)
- –û–±—É—á–µ–Ω–∏–µ –ò–ò-–∞–≥–µ–Ω—Ç–æ–≤ –Ω–∞ —Å–≤–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CRM —Å–∏—Å—Ç–µ–º–∞–º–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤

**–û–ø–ª–∞—Ç–∞:**
- –í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ Prodamus (–Ω–∞–¥—ë–∂–Ω–∞—è —Ä–æ—Å—Å–∏–π—Å–∫–∞—è –ø–ª–∞—Ç—ë–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞: –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã, –°–ë–ü, Apple Pay, Google Pay
- –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ —Å 3D-Secure
- –í—ã–¥–∞—ë—Ç—Å—è —Ñ–∏—Å–∫–∞–ª—å–Ω—ã–π —á–µ–∫ (54-–§–ó)

**–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**
- –ò–ü –î–º–∏—Ç—Ä–∏–µ–≤–∞ –û–ª—å–≥–∞ –ê–Ω–∞—Ç–æ–ª—å–µ–≤–Ω–∞
- –ò–ù–ù: 263504091920, –û–ì–†–ù: 318565800079487
- –ê–¥—Ä–µ—Å: 355040, –≥. –°—Ç–∞–≤—Ä–æ–ø–æ–ª—å, —É–ª. –ü–∏—Ä–æ–≥–æ–≤–∞ –¥.5/1
- –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: /legal
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ: /docs/terms
- –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏: /docs/privacy
- –ü—É–±–ª–∏—á–Ω–∞—è –æ—Ñ–µ—Ä—Ç–∞: /docs/oferta

**–°–µ—Å—Å–∏–∏:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã—Ö–æ–¥ —á–µ—Ä–µ–∑ 4 —á–∞—Å–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏
- –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ

**–ü–æ–¥–¥–µ—Ä–∂–∫–∞:**
- –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ (—Ç—ã) –¥–æ—Å—Ç—É–ø–µ–Ω 24/7
- Telegram-—Å–æ–æ–±—â–µ—Å—Ç–≤–æ: https://t.me/+QgiLIa1gFRY4Y2Iy

**–ü—Ä—è–º–∞—è —Å–≤—è–∑—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π:**
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç —Å–≤—è–∑–∞—Ç—å—Å—è –Ω–∞–ø—Ä—è–º—É—é —Å —á–µ–ª–æ–≤–µ–∫–æ–º –∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å —ç—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã:
- üë§ –°–∏—Å—Ç–µ–º–Ω—ã–π –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: –í–ª–∞–¥–∏–º–∏—Ä
- ‚úàÔ∏è Telegram: @Fou9725
–≠—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –≤—Å–µ—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏, –ø—Ä–æ–±–ª–µ–º —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π –∏ –ø—Ä—è–º–æ–≥–æ –æ–±—â–µ–Ω–∏—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π.

**–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:**
- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π
- –ü–æ–Ω—è—Ç–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –±–µ–∑ —Å–ª–æ–∂–Ω–æ–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
- –≠–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ (—É–º–µ—Ä–µ–Ω–Ω–æ)
- –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ ‚Äî —á–µ—Å—Ç–Ω–æ –ø—Ä–∏–∑–Ω–∞–π—Å—è –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É @Fou9725

–û—Ç–≤–µ—á–∞–π –≤—Å–µ–≥–¥–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ë—É–¥—å –ø–æ–ª–µ–∑–Ω—ã–º –∏ –ø–æ–º–æ–≥–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ."""

        # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
        is_continue = user_message.lower() in ['–ø—Ä–æ–¥–æ–ª–∂–∏ –æ—Ç–≤–µ—Ç', '–ø—Ä–æ–¥–æ–ª–∂–∏', 'continue']
        
        if is_continue and context:
            # –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è - –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –±–µ–∑ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π
            messages = [
                {'role': 'system', 'content': '–ü—Ä–æ–¥–æ–ª–∂–∏ —Ç–µ–∫—Å—Ç –±–µ–∑ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π –∏ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π. –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∏ —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è:'},
                {'role': 'assistant', 'content': context},
                {'role': 'user', 'content': '–ü—Ä–æ–¥–æ–ª–∂–∏'}
            ]
        else:
            messages = [{'role': 'system', 'content': system_prompt}]
            if context:
                messages.append({'role': 'assistant', 'content': context})
            messages.append({'role': 'user', 'content': user_message})
        
        request_data = {
            'model': 'tngtech/deepseek-r1t-chimera:free',
            'messages': messages,
            'temperature': 0.7,
            'max_tokens': 500
        }
        api_url = 'https://openrouter.ai/api/v1/chat/completions'
        
        try:
            print(f'Making request to OpenRouter API with model: tngtech/deepseek-r1t-chimera:free')
            req = urllib.request.Request(
                api_url,
                data=json.dumps(request_data).encode('utf-8'),
                headers={
                    'Authorization': f'Bearer {openrouter_key}',
                    'Content-Type': 'application/json',
                    'HTTP-Referer': 'https://intellektpro.ru',
                    'X-Title': 'IntellektPro AI Assistant'
                },
                method='POST'
            )
            
            response = urllib.request.urlopen(req, timeout=25)
            response_data = json.loads(response.read().decode('utf-8'))
            
            print(f'OpenRouter response received')
            
            full_response = response_data['choices'][0]['message']['content']
            print(f'Raw response (first 200 chars): {full_response[:200]}')
            
            # –£–±–∏—Ä–∞–µ–º —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è –º–æ–¥–µ–ª–∏
            import re
            
            # –£–¥–∞–ª—è–µ–º —Ç–µ–≥–∏ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π
            full_response = re.sub(r'<think>.*?</think>', '', full_response, flags=re.DOTALL | re.IGNORECASE)
            full_response = re.sub(r'<thinking>.*?</thinking>', '', full_response, flags=re.DOTALL | re.IGNORECASE)
            
            # Deepseek-–º–æ–¥–µ–ª—å —Å–Ω–∞—á–∞–ª–∞ –ø–∏—à–µ—Ç —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è, –ø–æ—Ç–æ–º –¥–≤–æ–π–Ω–æ–π –ø–µ—Ä–µ–Ω–æ—Å, –ø–æ—Ç–æ–º —Å–∞–º –æ—Ç–≤–µ—Ç
            # –ò—â–µ–º –ü–ï–†–í–´–ô –∞–±–∑–∞—Ü —Å —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è–º–∏ –∏ —É–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ
            
            # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–∞—á–∞–ª–∞ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π
            thinking_start_patterns = [
                '–•–æ—Ä–æ—à–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', '–ò—Ç–∞–∫, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç',
                '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç', '–ú–Ω–µ –Ω—É–∂–Ω–æ',
                '–°–Ω–∞—á–∞–ª–∞ —è', '–î–∞–≤–∞–π—Ç–µ'
            ]
            
            # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è - —É–¥–∞–ª—è–µ–º –≤–µ—Å—å –ø–µ—Ä–≤—ã–π –∞–±–∑–∞—Ü –¥–æ \n\n
            starts_with_thinking = any(full_response.startswith(pattern) for pattern in thinking_start_patterns)
            
            if starts_with_thinking and '\n\n' in full_response:
                # –£–¥–∞–ª—è–µ–º –≤—Å—ë –¥–æ –ø–µ—Ä–≤–æ–≥–æ –¥–≤–æ–π–Ω–æ–≥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞ (—ç—Ç–æ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–µ)
                parts = full_response.split('\n\n', 1)
                if len(parts) > 1:
                    full_response = parts[1].strip()
                    print(f'Removed thinking block, new response starts with: {full_response[:100]}')
            
            # –£–±–∏—Ä–∞–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ markdown
            full_response = full_response.replace('**', '')
            full_response = full_response.replace('###', '')
            full_response = full_response.replace('##', '')
            full_response = full_response.replace('#', '')
            
            # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
            full_response = '\n'.join(line.strip() for line in full_response.split('\n') if line.strip())
            
            print(f'Cleaned response (first 200 chars): {full_response[:200]}')
            
            truncated = len(full_response) >= 450
            
            return {
                'statusCode': 200,
                'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                'isBase64Encoded': False,
                'body': json.dumps({
                    'response': full_response.strip(),
                    'truncated': truncated
                })
            }
        except urllib.error.HTTPError as e:
            print(f'HTTP ERROR in assistant: {e.code} {str(e)}')
            if e.code == 429:
                return {
                    'statusCode': 200,
                    'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                    'isBase64Encoded': False,
                    'body': json.dumps({'response': '‚è≥ –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ò–ò. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É @Fou9725 –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞.'})
                }
            else:
                return {
                    'statusCode': 200,
                    'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                    'isBase64Encoded': False,
                    'body': json.dumps({'response': f'–û—à–∏–±–∫–∞ –ò–ò-—Å–µ—Ä–≤–∏—Å–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: @Fou9725'})
                }
        except Exception as e:
            print(f'ERROR in assistant: {str(e)}')
            import traceback
            print(f'Traceback: {traceback.format_exc()}')
            return {
                'statusCode': 200,
                'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                'isBase64Encoded': False,
                'body': json.dumps({'response': f'–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: @Fou9725'})
            }
    
    return {
        'statusCode': 405,
        'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
        'body': json.dumps({'error': 'Method not allowed'})
    }